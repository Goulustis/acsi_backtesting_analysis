---
title: "acsi_analysis.Rmd"
output: html_document
date: "2023-04-25"
author: "Hansen Han"
---

# ACSI Backtesting Analysis 
What is the relationship between the American Consumer Satisfaction Index (ACSI) scores and stock prices? What about across sectors?

score_data.csv - ACSI scores for a company for a given year
stock_data.csv - Stock price data for companies (starting on the first day of the year)


## --- Preparation ---

### Load Libraries / Set Options
```{r setup, warning=FALSE, echo = FALSE}
library(tidyverse)
library(magrittr)
library(gridExtra)

options(scipen = 999)
```

### Load Data

Load the ACSI score data
```{r message = FALSE}
score_data <- read_csv("score_data.csv")
score_data
```

#### How many unique company tickers are in the dataset? 
```{r}
score_data %>% pull(ticker) %>% unique() %>% length()
```

gather() the data
```{r}
score_data_long <- gather(score_data %>% select(-`...1`, -publicly_traded), year, score, -ticker, -company_name, -sector, na.rm = TRUE)
score_data_long$score <- as.numeric(score_data_long$score) #convert score from chr to numeric value
score_data_long
```

Load the corresponding stock data
```{r message = FALSE}
stock_data <- read_csv("stock_data.csv")
names(stock_data)[1] <- "ticker" #rename index to ticker 
stock_data
```

Merge the score data and price data together by ticker
```{r}
# gather() the data so it can be merged
stock_data_long <- gather(stock_data, year, price, -ticker, na.rm = TRUE)

# left_join() to combine the two 
analysis_data <- score_data_long %>% mutate(ticker_year = paste0(ticker, "_", year)) %>% left_join(stock_data_long %>% mutate(ticker_year = paste0(ticker, "_", year)) %>% select(-ticker, -year), by=c("ticker_year"="ticker_year")) %>% select(-ticker_year)
analysis_data
```


### Data Exploration

#### How many companies per sector?
```{r}
ggplot(score_data, aes(x = sector)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Publicly Traded Companies w/ ACSI Data by Sector", x = "Sector", y = "Count") +
  geom_text(stat = "count", aes(label = ..count..), hjust = -1, color="black", size=2) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) + 
  coord_flip() +
  theme_bw()
```

#### What does satisfaction look like across all sectors over all dates available?
```{r}
score_data_long %>% ggplot(aes(color=sector, y = score, x=reorder(sector,score,na.rm = TRUE))) + geom_boxplot(alpha=0.4) + geom_jitter(size=0.4, alpha=0.9) + theme_bw() +
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5)) + coord_flip() + theme(legend.position = "none") + ggtitle(paste0("")) + ylab("ACSI Score") + xlab("")  +
  ylim(c(45, 100))
```

### What sectors have the highest satisfaction scores across all the years available?

Calculate the mean score for each sector by year, then take the average across years and rank them
```{r}
sector_year_means <- score_data_long %>% 
  group_by(year, sector) %>% 
  summarize(mean_score = mean(score, na.rm = TRUE))

sector_means <- sector_year_means %>% 
  group_by(sector) %>% 
  summarize(mean_score = mean(mean_score, na.rm = TRUE)) 

#arrange from top to bottom
sector_means <- sector_means %>% 
  arrange(desc(mean_score))

sector_means %>% 
  mutate(rank = row_number(desc(mean_score)))
```


### Average stock price for companies with satisfaction data per year? 


Add in S&P 500 stock price information
```{r}
sp_500_data <- read_csv("sp_500_stock_df.csv")
names(sp_500_data)[1] <- "ticker"
sp_500_data <- gather(sp_500_data, year, price, -ticker, na.rm = TRUE)
sp_500_data
```


```{r}
# Sort the dataframe by ticker and year
stock_data_long <- stock_data_long[order(stock_data_long$ticker, stock_data_long$year),]

# Mark both data types
stock_data_long$type <- "ACSI Surveyed Companies"
sp_500_data$type <- "S&P 500"

# merge them together
stock_data_long %<>% full_join(sp_500_data)

# Use the 'dplyr' package to group the data by ticker and calculate the percent change from one year to the next
library(dplyr)

stock_data_long <- stock_data_long %>% 
  group_by(ticker) %>% 
  mutate(price_change_from_prev_year = (price - lag(price))/lag(price))

stock_data_long
```

How many tickers do we have in total now? Not all tickers in the dataset are still available (some are now defunct). 
```{r}
stock_data_long %>% pull(ticker) %>% unique() %>% length()
```


```{r}
# Calculate the median price change from previous year for each year
median_changes <- stock_data_long %>%
  group_by(year, type) %>%
  summarize(median_change = median(price_change_from_prev_year, na.rm = TRUE)) 

# How similar is the median stock changes year to year with the S&P 500? (using as a benchmark)
ggplot(data = median_changes, aes(x = year, y = median_change, fill = type)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.8) +
  labs(title = "Change in Stock Price by Year and Type", x = "Year", y = "Price Change", fill = "Type") +
  theme(plot.title = element_text(hjust = 0.5))  +
  guides(fill = guide_legend(ncol = 2)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

### How many years were median ACSI surveyed company returns higher than the S&P500?

```{r}
count_highest_types <- function(median_changes) {
  # Convert factor type column to character if needed
  if (is.factor(median_changes$type)) {
    median_changes$type <- as.character(median_changes$type)
  }
  
  highest_types <- c()
  for (x in median_changes$year %>% unique()) {
    yearly_data <- median_changes %>% filter(year == x)
    # Find the type with the highest median_change value
    highest_types <- c(highest_types, yearly_data$type[which.max(yearly_data$median_change)])
  }
  # Count the occurrences of each element in an array
  counts <- table(highest_types)
  
  # Return the counts
  return(counts)
}

count_highest_types(median_changes)
```

Pretty equivalent...


### Now lets compare cumulative performance of ACSI companies and S&P 500
```{r}
plot_cumulative_performance <- function(df) {
  
  starting_amount <- 100000
  # Calculate cumulative performance for each trading strategy
  df_cumulative <- df %>%
    group_by(type) %>%
    arrange(year) %>%
    mutate(cumulative_return = cumprod(1 + median_change) * starting_amount)
  
  # Loop through all possible types in df_cumulative and print the final cumulative return
  for (t in unique(df_cumulative$type)) {
    #get the standard deviation in returns
    annual_mean_return <- df %>% filter(type == t) %>% drop_na() %>% pull(median_change) %>% mean()
    annual_sd_return <- df %>% filter(type == t) %>% drop_na() %>% pull(median_change) %>% sd()
    print(paste0(t, ": ", annual_mean_return, "+/-", annual_sd_return))

    final_return <- df_cumulative %>% filter(type == t) %>% filter(year == max(year)) %>% pull(cumulative_return)
    cat(paste0(t, ": ", round(final_return, 2), "\n"))
    final_return <- (df_cumulative %>% filter(type == t) %>% filter(year == max(year)) %>% pull(cumulative_return) / starting_amount - 1) * 100
    cat(paste0(t, ": ", round(final_return, 2), "%\n"))
  }
  
  # Plot cumulative performance for each trading strategy
  ggplot(df_cumulative, aes(x = year, y = cumulative_return, color = type, group=type)) +
    geom_line(size = 1) +
    scale_y_continuous(labels = scales::dollar, limits=c(0,3000000)) +
    labs(x = "Year", y = "Portfolio Balance", title = "Cumulative Performance") +
    theme_classic() +
    guides(color=guide_legend(title="Group")) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    theme(legend.position = "right", legend.title=element_blank()) +
    theme(plot.title = element_text(face="bold")) +
    xlab("")
  
}

acsi_total_data <- median_changes %>% drop_na()

plot_cumulative_performance(median_changes %>% drop_na())
```


#### Compare the mean and standard deviation of median returns by year?

S&P 500
```{r}
median_changes %>% filter(type == "S&P 500") %>% drop_na() %>% pull(median_change) %>% mean()
median_changes %>% filter(type == "S&P 500") %>% drop_na() %>% pull(median_change) %>% sd()
```

ACSI Surveyed Companies
```{r}
median_changes %>% filter(type == "ACSI Surveyed Companies") %>% drop_na() %>% pull(median_change) %>% mean()
median_changes %>% filter(type == "ACSI Surveyed Companies") %>% drop_na() %>% pull(median_change) %>% sd()
```

The S&P 500 has a 10.0% mean return with a 17.8% SD over the time period available while ACSI Surveyed Companies had a 9.7% mean return.

Overall, it looks like the companies that were surveyed for inclusion in the ACSI had a cumulative higher performance than the S&P 500 despite having lower mean returns. But this can be skewed by a few good years (or reduced downturns, not overall more robust performance), 


## Analysis

### Does picking the top 5/10/25% of companies by consumer satisfaction score each year beat the bottom 5/10/25%? 

We need to label each row for each year as belonging to the top or bottom cutoff portion
```{r}
label_data <- function(df, top_cutoff, bottom_cutoff) {
  library(dplyr)
  
  df_labeled <- df %>% 
    group_by(year) %>% 
    mutate(top_score = quantile(score, 1 - top_cutoff),
           bottom_score = quantile(score, bottom_cutoff),
           label = case_when(score >= top_score ~ "top",
                             score <= bottom_score ~ "bottom",
                             TRUE ~ "none")) %>% 
    ungroup()
  
  return(df_labeled)
}
```


#### Top and Bottom 5%

Get the labels for each row, for each year

We add one to each year, since we will be looking at the price for the next year after the score comes out. We want to take the median return for each strategy over that time period. 

```{r}
labeled_data <- label_data(score_data_long %>% drop_na(), 0.05, 0.05)

top_ticker_year_pairs <- labeled_data %>% filter(label == "top") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

bottom_ticker_year_pairs <- labeled_data %>% filter(label == "bottom") %>%  mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

mid_ticker_year_pairs <- labeled_data %>% filter(label == "none") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

```


```{r}
stock_data_long <- stock_data_long[order(stock_data_long$ticker, stock_data_long$year),] %>% mutate(ticker_year = paste0(ticker, "_", year))

top_stock_data <- stock_data_long %>% filter(ticker_year %in% top_ticker_year_pairs) %>% select(-ticker_year)
top_stock_data$type <- "Top 5% Companies (ACSI Score)"

mid_stock_data <- stock_data_long %>% filter(ticker_year %in% mid_ticker_year_pairs) %>% select(-ticker_year)
mid_stock_data$type <- "Mid 90% Companies (ACSI Score)"

bottom_stock_data <- stock_data_long %>% filter(ticker_year %in% bottom_ticker_year_pairs) %>% select(-ticker_year)
bottom_stock_data$type <- "Bottom 5% Companies (ACSI Score)"

```

Merge them together
```{r}
compiled_data <- stock_data_long %>% filter(ticker == "SPY") %>% full_join(top_stock_data)# %>% full_join(mid_stock_data) %>% full_join(bottom_stock_data)

# why is it short, shouldn't it contain almost all the data? 
compiled_data
```

```{r}
median_changes <- compiled_data %>%
  group_by(year, type) %>%
  summarize(median_change = median(price_change_from_prev_year, na.rm = TRUE)) 

median_changes$type <- factor(median_changes$type, levels=c("S&P 500", "Top 5% Companies (ACSI Score)", "Mid 90% Companies (ACSI Score)", "Bottom 5% Companies (ACSI Score)"))

# How similar is the median stock changes year to year with the S&P 500? (using as a benchmark)
ggplot(data = median_changes, aes(x = year, y = median_change, fill = type)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.8) +
  labs(title = "Change in Stock Price by Year and Type", x = "Year", y = "Price Change", fill = "Type") +
  theme(plot.title = element_text(hjust = 0.5))  +
  guides(fill = guide_legend(ncol = 2)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  theme(legend.position = "top", legend.title=element_blank())
```

View cumulative performance
```{r}
p5_data <- median_changes %>% drop_na()

p5 <- plot_cumulative_performance(median_changes %>% drop_na())
p5
```

How many times was each strategy the highest performing? 
```{r}
count_highest_types(median_changes)
```

What about looking at specific years? This will be analyzed later to see if performance is declining in recent years...
```{r}
count_highest_types(median_changes %>% filter(year %in% c("1997", "1998", "1999", "2000", "2001")))
count_highest_types(median_changes %>% filter(year %in% c("2002", "2003", "2004", "2005", "2006")))
count_highest_types(median_changes %>% filter(year %in% c("2007", "2008", "2009", "2010", "2011")))
count_highest_types(median_changes %>% filter(year %in% c("2012", "2013", "2014", "2015", "2016")))
count_highest_types(median_changes %>% filter(year %in% c("2017", "2018", "2019", "2020", "2021")))
```



#### Top and Bottom 10% 


```{r}
# Re-run logic from top and bottom 5% with altered parameters/labels....
labeled_data <- label_data(score_data_long %>% drop_na(), 0.1, 0.1)

top_ticker_year_pairs <- labeled_data %>% filter(label == "top") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

bottom_ticker_year_pairs <- labeled_data %>% filter(label == "bottom") %>%  mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

mid_ticker_year_pairs <- labeled_data %>% filter(label == "none") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

stock_data_long <- stock_data_long[order(stock_data_long$ticker, stock_data_long$year),] %>% mutate(ticker_year = paste0(ticker, "_", year))

top_stock_data <- stock_data_long %>% filter(ticker_year %in% top_ticker_year_pairs) %>% select(-ticker_year)
top_stock_data$type <- "Top 10% Companies (ACSI Score)"

mid_stock_data <- stock_data_long %>% filter(ticker_year %in% mid_ticker_year_pairs) %>% select(-ticker_year)
mid_stock_data$type <- "Mid 80% Companies (ACSI Score)"

bottom_stock_data <- stock_data_long %>% filter(ticker_year %in% bottom_ticker_year_pairs) %>% select(-ticker_year)
bottom_stock_data$type <- "Bottom 10% Companies (ACSI Score)"

compiled_data <- stock_data_long %>% filter(ticker == "SPY") %>% full_join(top_stock_data) #%>% full_join(mid_stock_data) %>% full_join(bottom_stock_data)

median_changes <- compiled_data %>%
  group_by(year, type) %>%
  summarize(median_change = median(price_change_from_prev_year, na.rm = TRUE)) 

median_changes$type <- factor(median_changes$type, levels=c("S&P 500", "Top 10% Companies (ACSI Score)", "Mid 80% Companies (ACSI Score)", "Bottom 10% Companies (ACSI Score)"))

# How similar is the median stock changes year to year with the S&P 500? (using as a benchmark)
ggplot(data = median_changes, aes(x = year, y = median_change, fill = type)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.8) +
  labs(title = "Change in Stock Price by Year and Type", x = "Year", y = "Price Change", fill = "Type") +
  theme(plot.title = element_text(hjust = 0.5))  +
  guides(fill = guide_legend(ncol = 2)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  theme(legend.position = "top", legend.title=element_blank()) + xlab("")

p10_data <- median_changes %>% drop_na()

p10 <- plot_cumulative_performance(median_changes %>% drop_na())
p10
```
How many times was each strategy the highest performing? 
```{r}
count_highest_types(median_changes)
```

Looking at compative performance by 5 year periods....
```{r}
count_highest_types(median_changes %>% filter(year %in% c("1997", "1998", "1999", "2000", "2001")))
count_highest_types(median_changes %>% filter(year %in% c("2002", "2003", "2004", "2005", "2006")))
count_highest_types(median_changes %>% filter(year %in% c("2007", "2008", "2009", "2010", "2011")))
count_highest_types(median_changes %>% filter(year %in% c("2012", "2013", "2014", "2015", "2016")))
count_highest_types(median_changes %>% filter(year %in% c("2017", "2018", "2019", "2020", "2021")))
```

#### Top and Bottom 25% 

```{r}
# Re-run logic from top and bottom 5% with altered parameters/labels....
labeled_data <- label_data(score_data_long %>% drop_na(), 0.25, 0.25)

top_ticker_year_pairs <- labeled_data %>% filter(label == "top") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

bottom_ticker_year_pairs <- labeled_data %>% filter(label == "bottom") %>%  mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

mid_ticker_year_pairs <- labeled_data %>% filter(label == "none") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

stock_data_long <- stock_data_long[order(stock_data_long$ticker, stock_data_long$year),] %>% mutate(ticker_year = paste0(ticker, "_", year))

top_stock_data <- stock_data_long %>% filter(ticker_year %in% top_ticker_year_pairs) %>% select(-ticker_year)
top_stock_data$type <- "Top 25% Companies (ACSI Score)"

mid_stock_data <- stock_data_long %>% filter(ticker_year %in% mid_ticker_year_pairs) %>% select(-ticker_year)
mid_stock_data$type <- "Mid 50% Companies (ACSI Score)"

bottom_stock_data <- stock_data_long %>% filter(ticker_year %in% bottom_ticker_year_pairs) %>% select(-ticker_year)
bottom_stock_data$type <- "Bottom 25% Companies (ACSI Score)"

compiled_data <- stock_data_long %>% filter(ticker == "SPY") %>% full_join(top_stock_data) #%>% full_join(mid_stock_data) %>% full_join(bottom_stock_data)

median_changes <- compiled_data %>%
  group_by(year, type) %>%
  summarize(median_change = median(price_change_from_prev_year, na.rm = TRUE)) 

median_changes$type <- factor(median_changes$type, levels=c("S&P 500", "Top 25% Companies (ACSI Score)", "Mid 50% Companies (ACSI Score)", "Bottom 25% Companies (ACSI Score)"))

# How similar is the median stock changes year to year with the S&P 500? (using as a benchmark)
ggplot(data = median_changes, aes(x = year, y = median_change, fill = type)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.8) +
  labs(title = "Change in Stock Price by Year and Type", x = "Year", y = "Price Change", fill = "Type") +
  theme(plot.title = element_text(hjust = 0.5))  +
  guides(fill = guide_legend(ncol = 2)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  theme(legend.position = "top", legend.title=element_blank()) + xlab("")

p25_data <- median_changes %>% drop_na()

p25 <- plot_cumulative_performance(median_changes %>% drop_na())
p25
```
How many times was each strategy the highest performing? 
```{r}
count_highest_types(median_changes)
```

Looking at compative performance by 5 year periods....
```{r}
count_highest_types(median_changes %>% filter(year %in% c("1997", "1998", "1999", "2000", "2001")))
count_highest_types(median_changes %>% filter(year %in% c("2002", "2003", "2004", "2005", "2006")))
count_highest_types(median_changes %>% filter(year %in% c("2007", "2008", "2009", "2010", "2011")))
count_highest_types(median_changes %>% filter(year %in% c("2012", "2013", "2014", "2015", "2016")))
count_highest_types(median_changes %>% filter(year %in% c("2017", "2018", "2019", "2020", "2021")))
```

#### Top and Bottom 1% 

```{r}
# Re-run logic from top and bottom 5% with altered parameters/labels....
labeled_data <- label_data(score_data_long %>% drop_na(), 0.01, 0.01)

top_ticker_year_pairs <- labeled_data %>% filter(label == "top") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

bottom_ticker_year_pairs <- labeled_data %>% filter(label == "bottom") %>%  mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

mid_ticker_year_pairs <- labeled_data %>% filter(label == "none") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

stock_data_long <- stock_data_long[order(stock_data_long$ticker, stock_data_long$year),] %>% mutate(ticker_year = paste0(ticker, "_", year))

top_stock_data <- stock_data_long %>% filter(ticker_year %in% top_ticker_year_pairs) %>% select(-ticker_year)
top_stock_data$type <- "Top 1% Companies (ACSI Score)"

mid_stock_data <- stock_data_long %>% filter(ticker_year %in% mid_ticker_year_pairs) %>% select(-ticker_year)
mid_stock_data$type <- "Mid 98% Companies (ACSI Score)"

bottom_stock_data <- stock_data_long %>% filter(ticker_year %in% bottom_ticker_year_pairs) %>% select(-ticker_year)
bottom_stock_data$type <- "Bottom 1% Companies (ACSI Score)"

compiled_data <- stock_data_long %>% filter(ticker == "SPY") %>% full_join(top_stock_data) #%>% full_join(mid_stock_data) %>% full_join(bottom_stock_data)

median_changes <- compiled_data %>%
  group_by(year, type) %>%
  summarize(median_change = median(price_change_from_prev_year, na.rm = TRUE)) 

median_changes$type <- factor(median_changes$type, levels=c("S&P 500", "Top 1% Companies (ACSI Score)", "Mid 98% Companies (ACSI Score)", "Bottom 1% Companies (ACSI Score)"))

# How similar is the median stock changes year to year with the S&P 500? (using as a benchmark)
ggplot(data = median_changes, aes(x = year, y = median_change, fill = type)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.8) +
  labs(title = "Change in Stock Price by Year and Type", x = "Year", y = "Price Change", fill = "Type") +
  theme(plot.title = element_text(hjust = 0.5))  +
  guides(fill = guide_legend(ncol = 2)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  theme(legend.position = "top", legend.title=element_blank()) + xlab("")

p1_data <- median_changes %>% drop_na()

p1 <- plot_cumulative_performance(median_changes %>% drop_na())
p1
```

Huh, how about that...I decided to just try running 1% after 5/10/25% for fun, and didn't expect to see anything - but this result actually is the most pronounced of any. Looking at the change by year, it looks like there was extraordinary performance in 2004 (more than doubling of stock price).

How many times was each strategy the highest performing? 
```{r}
count_highest_types(median_changes)
```

Looking at compative performance by 5 year periods....
```{r}
count_highest_types(median_changes %>% filter(year %in% c("1997", "1998", "1999", "2000", "2001")))
count_highest_types(median_changes %>% filter(year %in% c("2002", "2003", "2004", "2005", "2006")))
count_highest_types(median_changes %>% filter(year %in% c("2007", "2008", "2009", "2010", "2011")))
count_highest_types(median_changes %>% filter(year %in% c("2012", "2013", "2014", "2015", "2016")))
count_highest_types(median_changes %>% filter(year %in% c("2017", "2018", "2019", "2020", "2021")))
```

What company(s) is driving this?
```{r}
top_stock_data %>% filter(year == 2004)
```
Amazon! 

What companies are in the top companies and bottom companies?
```{r}
#top companies
score_data %>% filter(ticker %in% c(top_stock_data %>% pull(ticker) %>% unique())) 
```

```{r}
# bottom companies
score_data %>% filter(ticker %in% c(bottom_stock_data %>% pull(ticker) %>% unique()))
```


#### Create composite plot
```{r}
grid.arrange(p1 +
  theme(legend.position = "none") + ggtitle("99th Percentile") + ylab(""), 
  p5 +
  theme(legend.position = "none") + ggtitle("95th Percentile") + ylab(""), 
  p10 +
  theme(legend.position = "none") + ggtitle("90th Percentile") + ylab(""), 
  p25 +
  theme(legend.position = "none") + ggtitle("75th Percentile") + ylab("")) 
```


### What does the curve look like for % picked and cumulative returns?
```{r}

#function to extract cumulative performance each time
get_cumulative_performance <- function(df) {
  
  starting_amount <- 100000
  # Calculate cumulative performance for each trading strategy
  df_cumulative <- df %>%
    group_by(type) %>%
    arrange(year) %>%
    mutate(cumulative_return = cumprod(1 + median_change) * starting_amount)
  
  # Loop through all possible types in df_cumulative and print the final cumulative return
  for (t in unique(df_cumulative$type)) {
    final_return <- df_cumulative %>% filter(type == t) %>% filter(year == max(year)) %>% pull(cumulative_return)
    cat(paste0(t, ": ", round(final_return, 2), "\n"))
    final_return <- (df_cumulative %>% filter(type == t) %>% filter(year == max(year)) %>% pull(cumulative_return) / starting_amount - 1) * 100
    cat(paste0(t, ": ", round(final_return, 2), "%\n"))
  }
  
  final_return

}

return_results <- c()

for (input_percentile in seq(from = 0.01, to = 0.99, by = 0.01)) {
  
  labeled_data <- label_data(score_data_long %>% drop_na(), input_percentile, 0.01)
  
  top_ticker_year_pairs <- labeled_data %>% filter(label == "top") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 
  
  bottom_ticker_year_pairs <- labeled_data %>% filter(label == "bottom") %>%  mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 
  
  mid_ticker_year_pairs <- labeled_data %>% filter(label == "none") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 
  
  stock_data_long <- stock_data_long[order(stock_data_long$ticker, stock_data_long$year),] %>% mutate(ticker_year = paste0(ticker, "_", year))
  
  top_stock_data <- stock_data_long %>% filter(ticker_year %in% top_ticker_year_pairs) %>% select(-ticker_year)
  top_stock_data$type <- "Top 1% Companies (ACSI Score)"
  
  mid_stock_data <- stock_data_long %>% filter(ticker_year %in% mid_ticker_year_pairs) %>% select(-ticker_year)
  mid_stock_data$type <- "Mid 98% Companies (ACSI Score)"
  
  bottom_stock_data <- stock_data_long %>% filter(ticker_year %in% bottom_ticker_year_pairs) %>% select(-ticker_year)
  bottom_stock_data$type <- "Bottom 1% Companies (ACSI Score)"
  
  compiled_data <- stock_data_long %>% filter(ticker == "SPY") %>% full_join(top_stock_data) #%>% full_join(mid_stock_data) %>% full_join(bottom_stock_data)
  
  # If you want to look across specific years
  #compiled_data %<>% filter(year %in% c("2017", "2018", "2019", "2020", "2021"))
  #compiled_data %<>% filter(year %in% c("2012", "2013", "2014", "2015", "2016"))
  #compiled_data %<>% filter(year %in% c("2007", "2008", "2009", "2010", "2011"))
  #compiled_data %<>% filter(year %in% c("2002", "2003", "2004", "2005", "2006"))
  #compiled_data %<>% filter(year %in% c("1997", "1998", "1999", "2000", "2001"))
  
  median_changes <- compiled_data %>%
    group_by(year, type) %>%
    summarize(median_change = median(price_change_from_prev_year, na.rm = TRUE)) 
  
  median_changes$type <- factor(median_changes$type, levels=c("S&P 500", "Top 1% Companies (ACSI Score)", "Mid 98% Companies (ACSI Score)", "Bottom 1% Companies (ACSI Score)"))
  
  
  
  
  
  return_results <- c(return_results, get_cumulative_performance(median_changes %>% drop_na()))
}

return_results
```



Plot the two
```{r}
# Generate example data
x <- rev(seq(from = 0.01, to = 0.99, by = 0.01))
y <- return_results

# Combine x and y into a data frame
data <- data.frame(x, y)

# Create plot object
ggplot(data, aes(x=x, y=y)) + 

  # Add line layer
  geom_line(color="#1cb4b6") +
  
  # Add x and y axis labels
  xlab("ACSI Percentile") + ylab("Returns (%)") +
  
  # Add plot title
  ggtitle("") + theme_bw() + geom_hline(yintercept=114.96,linetype=2, color = "#f55c54") +
  geom_area(aes(fill=y), alpha = 0.2) + theme_classic() +
  theme(legend.position = "none") 
```



### Does picking the top company in each sector in terms of consumer satisfaction beat the S&P 500? 
```{r}
# take the top one in each sector, needs to be slightly modified
label_data_sector <- function(df, top_cutoff, bottom_cutoff) {

  rows <- 2 # we want to filter out sectors with less than 2 companies in that year 
  
  df_labeled <- df %>% 
    group_by(year, sector) %>% 
    mutate(top_score = quantile(score, 1 - top_cutoff),
           bottom_score = quantile(score, bottom_cutoff),
           label = case_when(score >= top_score ~ "top",
                             score <= bottom_score ~ "bottom",
                             TRUE ~ "none")) %>% filter(n() >= rows) %>% 
    ungroup()
  
  return(df_labeled)
}
```



```{r}
labeled_data <- label_data_sector(score_data_long %>% drop_na(), 0.01, 0.01) #take the companies in the 99th and 1st Percentiles

top_ticker_year_pairs <- labeled_data %>% filter(label == "top") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

bottom_ticker_year_pairs <- labeled_data %>% filter(label == "bottom") %>%  mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

mid_ticker_year_pairs <- labeled_data %>% filter(label == "none") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

stock_data_long <- stock_data_long[order(stock_data_long$ticker, stock_data_long$year),] %>% mutate(ticker_year = paste0(ticker, "_", year))

top_stock_data <- stock_data_long %>% filter(ticker_year %in% top_ticker_year_pairs) %>% select(-ticker_year)
top_stock_data$type <- "Top Company in Each Sector"

mid_stock_data <- stock_data_long %>% filter(ticker_year %in% mid_ticker_year_pairs) %>% select(-ticker_year)
mid_stock_data$type <- "Other Companies (ACSI Score)"

bottom_stock_data <- stock_data_long %>% filter(ticker_year %in% bottom_ticker_year_pairs) %>% select(-ticker_year)
bottom_stock_data$type <- "Bottom Companies in Each Sector (ACSI Score)"

compiled_data <- stock_data_long %>% filter(ticker == "SPY") %>% full_join(top_stock_data) #%>% full_join(mid_stock_data) %>% full_join(bottom_stock_data)

median_changes <- compiled_data %>%
  group_by(year, type) %>%
  summarize(median_change = median(price_change_from_prev_year, na.rm = TRUE)) 

median_changes$type <- factor(median_changes$type, levels=c("S&P 500", "Top Company in Each Sector", "Other Companies (ACSI Score)", "Bottom Companies in Each Sector (ACSI Score)"))

# How similar is the median stock changes year to year with the S&P 500? (using as a benchmark)
ggplot(data = median_changes, aes(x = year, y = median_change, fill = type)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.8) +
  labs(title = "Change in Stock Price by Year and Type", x = "Year", y = "Price Change", fill = "Type") +
  theme(plot.title = element_text(hjust = 0.5))  +
  guides(fill = guide_legend(ncol = 2)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  theme(legend.position = "top", legend.title=element_blank()) + xlab("")


ps_data <- median_changes %>% drop_na()

plot_cumulative_performance(median_changes %>% drop_na()) + xlab("")


```
How many times was each strategy the highest performing? 
```{r}
count_highest_types(median_changes)
```

```{r}
count_highest_types(median_changes %>% filter(year %in% c("1997", "1998", "1999", "2000", "2001")))
count_highest_types(median_changes %>% filter(year %in% c("2002", "2003", "2004", "2005", "2006")))
count_highest_types(median_changes %>% filter(year %in% c("2007", "2008", "2009", "2010", "2011")))
count_highest_types(median_changes %>% filter(year %in% c("2012", "2013", "2014", "2015", "2016")))
count_highest_types(median_changes %>% filter(year %in% c("2017", "2018", "2019", "2020", "2021")))
```

Picking the top company in each sector seems to do better than S&P500 and other strategies.



### Does the trend break down after a certain year? After the results were published? 


#### Top 1%


```{r}
# Re-run logic from top and bottom 5% with altered parameters/labels....
labeled_data <- label_data(score_data_long %>% drop_na(), 0.01, 0.01)

top_ticker_year_pairs <- labeled_data %>% filter(label == "top") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

bottom_ticker_year_pairs <- labeled_data %>% filter(label == "bottom") %>%  mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

mid_ticker_year_pairs <- labeled_data %>% filter(label == "none") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

stock_data_long <- stock_data_long[order(stock_data_long$ticker, stock_data_long$year),] %>% mutate(ticker_year = paste0(ticker, "_", year))

top_stock_data <- stock_data_long %>% filter(ticker_year %in% top_ticker_year_pairs) %>% select(-ticker_year)
top_stock_data$type <- "Top 1% Companies (ACSI Score)"

mid_stock_data <- stock_data_long %>% filter(ticker_year %in% mid_ticker_year_pairs) %>% select(-ticker_year)
mid_stock_data$type <- "Mid 98% Companies (ACSI Score)"

bottom_stock_data <- stock_data_long %>% filter(ticker_year %in% bottom_ticker_year_pairs) %>% select(-ticker_year)
bottom_stock_data$type <- "Bottom 1% Companies (ACSI Score)"

compiled_data <- stock_data_long %>% filter(ticker == "SPY") %>% full_join(top_stock_data) #%>% full_join(mid_stock_data) %>% full_join(bottom_stock_data)

# Only look in recent years
#compiled_data %<>% filter(year %in% c("2014", "2015", "2016", "2017", "2018", "2019", "2020"))

median_changes <- compiled_data %>%
  group_by(year, type) %>%
  summarize(median_change = median(price_change_from_prev_year, na.rm = TRUE)) 

median_changes$type <- factor(median_changes$type, levels=c("S&P 500", "Top 1% Companies (ACSI Score)", "Mid 98% Companies (ACSI Score)", "Bottom 1% Companies (ACSI Score)"))

# How similar is the median stock changes year to year with the S&P 500? (using as a benchmark)
ggplot(data = median_changes, aes(x = year, y = median_change, fill = type)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.8) +
  labs(title = "Change in Stock Price by Year and Type", x = "Year", y = "Price Change", fill = "Type") +
  theme(plot.title = element_text(hjust = 0.5))  +
  guides(fill = guide_legend(ncol = 2)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  theme(legend.position = "top", legend.title=element_blank()) + xlab("")

p1 <- plot_cumulative_performance(median_changes %>% drop_na())
p1
```


```{r}
top_1_percentile_data <- median_changes
```


```{r}
ggplot(median_changes, aes(x = year, y = median_change, color = type, group=type)) +
    geom_line(size = 1) +
    labs(x = "Year", y = "Change", title = "Cumulative Performance") +
    theme_classic() +
    guides(color=guide_legend(title="Group")) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    theme(legend.position = "right", legend.title=element_blank()) +
    theme(plot.title = element_text(face="bold")) +
    xlab("") + geom_hline(yintercept=0,linetype=2, color = "grey")
```


#### Top Company in Each Sector

```{r}
labeled_data <- label_data_sector(score_data_long %>% drop_na(), 0.01, 0.01) #take the companies in the 99th and 1st Percentiles


top_ticker_year_pairs <- labeled_data %>% filter(label == "top") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

bottom_ticker_year_pairs <- labeled_data %>% filter(label == "bottom") %>%  mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

mid_ticker_year_pairs <- labeled_data %>% filter(label == "none") %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 

stock_data_long <- stock_data_long[order(stock_data_long$ticker, stock_data_long$year),] %>% mutate(ticker_year = paste0(ticker, "_", year))

top_stock_data <- stock_data_long %>% filter(ticker_year %in% top_ticker_year_pairs) %>% select(-ticker_year)
top_stock_data$type <- "Top Company in Each Sector"

mid_stock_data <- stock_data_long %>% filter(ticker_year %in% mid_ticker_year_pairs) %>% select(-ticker_year)
mid_stock_data$type <- "Other Companies (ACSI Score)"

bottom_stock_data <- stock_data_long %>% filter(ticker_year %in% bottom_ticker_year_pairs) %>% select(-ticker_year)
bottom_stock_data$type <- "Bottom Companies in Each Sector (ACSI Score)"

compiled_data <- stock_data_long %>% filter(ticker == "SPY") %>% full_join(top_stock_data) #%>% full_join(mid_stock_data) %>% full_join(bottom_stock_data)

# Only look in recent years
#compiled_data %<>% filter(year %in% c("2014", "2015", "2016", "2017", "2018", "2019", "2020"))

median_changes <- compiled_data %>%
  group_by(year, type) %>%
  summarize(median_change = median(price_change_from_prev_year, na.rm = TRUE)) 

median_changes$type <- factor(median_changes$type, levels=c("S&P 500", "Top Company in Each Sector", "Other Companies (ACSI Score)", "Bottom Companies in Each Sector (ACSI Score)"))

# How similar is the median stock changes year to year with the S&P 500? (using as a benchmark)
ggplot(data = median_changes, aes(x = year, y = median_change, fill = type)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.8) +
  labs(title = "Change in Stock Price by Year and Type", x = "Year", y = "Price Change", fill = "Type") +
  theme(plot.title = element_text(hjust = 0.5))  +
  guides(fill = guide_legend(ncol = 2)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  theme(legend.position = "top", legend.title=element_blank()) + xlab("")

plot_cumulative_performance(median_changes %>% drop_na()) + xlab("")


```
Plot the performance per year
```{r}
ggplot(median_changes, aes(x = year, y = median_change, color = type, group=type)) +
    geom_line(size = 1) +
    labs(x = "Year", y = "Change", title = "Cumulative Performance") +
    theme_classic() +
    guides(color=guide_legend(title="Group")) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    theme(legend.position = "right", legend.title=element_blank()) +
    theme(plot.title = element_text(face="bold")) +
    xlab("") + geom_hline(yintercept=0,linetype=2, color = "grey")
```

Compare top company in each sector and top 1%
```{r}
top_1_percentile_data %<>% filter(type != "S&P 500")
ggplot(median_changes %>% full_join(top_1_percentile_data), aes(x = year, y = median_change, color = type, group=type)) +
    geom_line(size = 1) +
    labs(x = "Year", y = "Change", title = "Annual Returns") +
    theme_classic() +
    guides(color=guide_legend(title="Group")) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    theme(legend.position = "right", legend.title=element_blank()) +
    theme(plot.title = element_text(face="bold")) +
    xlab("") + geom_hline(yintercept=0,linetype=2, color = "grey")
```


### Does picking sectors with the highest satisfaction beat the S&P 500?
This needs to be expanded, we need to add logic that picks the sector with the highest scores. This is slightly derivative and not that different though...


```{r}
# create the first one
compiled_data <- stock_data_long %>% filter(ticker == "SPY")


# go through each sector
for (sector_type in score_data_long$sector %>% unique()) {
  sector_ticker_year_pairs <- score_data_long %>% filter(sector == sector_type) %>% mutate(ticker_year = paste0(ticker, "_", as.numeric(year) + 1)) %>% pull(ticker_year) 
  select_stock_data <- stock_data_long %>% filter(ticker_year %in% sector_ticker_year_pairs) %>% select(-ticker_year)
select_stock_data$type <- sector_type

  

  # add it to the compiled data
  compiled_data %<>% full_join(select_stock_data)
  
}


median_changes <- compiled_data %>%
  group_by(year, type) %>%
  summarize(median_change = median(price_change_from_prev_year, na.rm = TRUE)) 

sector_options <- c("S&P 500")
for (sector_name in score_data_long$sector %>% unique()) {
  sector_options <- c(sector_options, sector_name)
}
 
median_changes$type <- factor(median_changes$type, levels=sector_options)

# How similar is the median stock changes year to year with the S&P 500? (using as a benchmark)
ggplot(data = median_changes, aes(x = year, y = median_change, fill = type)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.8) +
  labs(title = "Change in Stock Price by Year and Type", x = "Year", y = "Price Change", fill = "Type") +
  theme(plot.title = element_text(hjust = 0.5))  +
  guides(fill = guide_legend(ncol = 2)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  theme(legend.position = "top", legend.title=element_blank()) + xlab("")

plot_cumulative_performance(median_changes %>% drop_na()) + xlab("")
```


### Create cumulative plot for all strategies


We need to make a slightly bigger one to handle the large (4M increase)
```{r}
plot_cumulative_performance_modified <- function(df) {
  
  starting_amount <- 100000
  # Calculate cumulative performance for each trading strategy
  df_cumulative <- df %>%
    group_by(type) %>%
    arrange(year) %>%
    mutate(cumulative_return = cumprod(1 + median_change) * starting_amount)
  
  # Loop through all possible types in df_cumulative and print the final cumulative return
  for (t in unique(df_cumulative$type)) {
    #get the standard deviation in returns
    annual_mean_return <- df %>% filter(type == t) %>% drop_na() %>% pull(median_change) %>% mean()
    annual_sd_return <- df %>% filter(type == t) %>% drop_na() %>% pull(median_change) %>% sd()
    print(paste0(t, ": ", annual_mean_return, "+/-", annual_sd_return))

    final_return <- df_cumulative %>% filter(type == t) %>% filter(year == max(year)) %>% pull(cumulative_return)
    cat(paste0(t, ": ", round(final_return, 2), "\n"))
    final_return <- (df_cumulative %>% filter(type == t) %>% filter(year == max(year)) %>% pull(cumulative_return) / starting_amount - 1) * 100
    cat(paste0(t, ": ", round(final_return, 2), "%\n"))
  }
  
  # Plot cumulative performance for each trading strategy
  ggplot(df_cumulative, aes(x = year, y = cumulative_return, color = type, group=type)) +
    geom_line(size=1) +
    scale_y_continuous(labels = scales::dollar, limits=c(0,4000000)) +
    labs(x = "Year", y = "Portfolio Balance", title = "Cumulative Performance") +
    theme_classic() +
    guides(color=guide_legend(title="Group")) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    theme(legend.position = "right", legend.title=element_blank()) +
    theme(plot.title = element_text(face="bold")) +
    xlab("")
  
}

```


```{r}
all_strategy_data <- p1_data %>% full_join(p5_data) %>% full_join(p10_data) %>% full_join(p25_data) %>% full_join(ps_data) %>% full_join(acsi_total_data) %>% distinct()

all_strategy_data %<>% mutate(type = case_when(
  type == "S&P 500" ~ "S&P 500",
  type == "Top 1% Companies (ACSI Score)" ~ "99th Percentile Across All Sectors",
  type == "Top 5% Companies (ACSI Score)" ~ "95th Percentile Across All Sectors",
  type == "Top 10% Companies (ACSI Score)" ~ "10th Percentile Across All Sectors",
  type == "Top 25% Companies (ACSI Score)" ~ "75th Percentile Across All Sectors",
  type == "Top Company in Each Sector" ~ "Top Company in Each Sector",
  type == "ACSI Surveyed Companies" ~ "All Publicly Traded Companies w/ ACSI Data",
))

all_strategy_data %<>% drop_na()

all_strategy_data$type <- factor(all_strategy_data$type, levels=c("Top Company in Each Sector", "99th Percentile Across All Sectors", "95th Percentile Across All Sectors", "90th Percentile Across All Sectors", "75th Percentile Across All Sectors", "All Publicly Traded Companies w/ ACSI Data", "S&P 500"))

cp1 <- plot_cumulative_performance_modified(all_strategy_data %>% drop_na()) + xlab("") + theme_bw() + theme(legend.position = "none", legend.title=element_blank())

df <- all_strategy_data

sp500_median <- df %>%
  filter(type == "S&P 500") %>%
  select(year, sp500_median_change = median_change)

# Join the original dataframe with the S&P 500 median changes
df <- df %>%
  left_join(sp500_median, by = "year") %>%
  mutate(median_change = median_change - sp500_median_change) %>%
  select(-sp500_median_change)


cp2 <- ggplot(data = df %>% drop_na(), aes(x = year, y = median_change, fill = type)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.8) +
  labs(title = "Change in Stock Price by Year and Type", x = "Year", y = "Price Change vs. S&P 500", fill = "Type") +
  theme(plot.title = element_text(hjust = 0.5))  +
  guides(fill = guide_legend(ncol = 2)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  theme(legend.position = "top", legend.title=element_blank()) + xlab("")

```



```{r}
grid.arrange(cp2 + ggtitle(""), cp1 + ggtitle(""))
```




### Create plot of performance of the core strategies over 5 year intervals in terms of beating the S&P 500
```{r}
data <- data.frame(
  Strategy = c("95th Percentile Across All Sectors", "90th Percentile Across All Sectors",
               "75th Percentile Across All Sectors", "99th Percentile Across All Sectors",
               "Top Company in Each Sector"),
  `1997 - 2001` = c(0.4, 0.4, 0.4, 0.4, 0.6),
  `2002 - 2006` = c(0.8, 0.8, 0.6, 1, 0.8),
  `2007 - 2011` = c(0.8, 0.6, 0, 0.6, 0.8),
  `2012 - 2016` = c(0.2, 0.2, 0.4, 0.4, 0.8),
  `2017 - 2021` = c(0.2, 0, 0, 0.2, 0.4)
)
data$Strategy <- factor(data$Strategy, levels=c("Top Company in Each Sector", "99th Percentile Across All Sectors", "95th Percentile Across All Sectors", "90th Percentile Across All Sectors", "75th Percentile Across All Sectors"))

data_long <- gather(data, key = "Period", value = "Value", -Strategy)

# rename x_labels since they are currently formatted as X1997-2001, X2002...
x_labels <- c("1997 - 2001", "2002 - 2006", "2007 - 2011", "2012 - 2016", "2017 - 2021")

ggplot(data_long, aes(x = Period, y = Value, group = Strategy, color = Strategy)) +
  geom_line(size= 1) +
  labs(x = "Period", y = "Proportion of Years Beating the S&P 500") + theme_bw() + xlab("Five Year Period") +
  scale_x_discrete(labels = x_labels)
```

